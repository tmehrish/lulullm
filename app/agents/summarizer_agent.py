import bs4
import re
import logging
import os
from dotenv import load_dotenv
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_community.document_loaders import WebBaseLoader
from langchain_community.vectorstores import Chroma
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import RunnablePassthrough
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI, OpenAIEmbeddings
from langchain.schema import HumanMessage
from langgraph.checkpoint.memory import MemorySaver
from langgraph.prebuilt import create_react_agent

# Load environment variables
load_dotenv()
key = os.getenv("OPENAI_API_KEY")

prompt_template = '''
                Take the given chat history and ONLY return the AIMessage
                and HumanMessage content. Do not return any other metadata
                '''

# Build agent
llm = ChatOpenAI(model_name="gpt-4o", temperature=0, api_key=key)

summarizer_agent = create_react_agent(
    llm,
    tools=[],
    prompt=prompt_template,
    checkpointer=MemorySaver(),
)

# Example usage
response = summarizer_agent.invoke({"messages": '''
                                    {'messages': [HumanMessage(content='help idk what to eat for lunch ', additional_kwargs={}, response_metadata={}, id='e1d8ddcd-ce07-48b4-a807-3384eb9674dd'), AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_ysagmZPkenN7bxcJaW15Z1Uq', 'function': {'arguments': '{}', 'name': 'transfer_to_decision_maker_agent'}, 'type': 'function'}], 'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 15, 'prompt_tokens': 398, 'total_tokens': 413, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-2024-08-06', 'system_fingerprint': 'fp_d8864f8b6b', 'id': 'chatcmpl-BZNpsWWQiXnBPtPPDZ2cooSCnHwLf', 'service_tier': 'default', 'finish_reason': 'tool_calls', 'logprobs': None}, name='supervisor', id='run--85e3e090-b269-4a0c-b9ac-6a6c97e31ace-0', tool_calls=[{'name': 'transfer_to_decision_maker_agent', 'args': {}, 'id': 'call_ysagmZPkenN7bxcJaW15Z1Uq', 'type': 'tool_call'}], usage_metadata={'input_tokens': 398, 'output_tokens': 15, 'total_tokens': 413, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}), ToolMessage(content='Successfully transferred to decision_maker_agent', name='transfer_to_decision_maker_agent', id='3d1f17bb-6bc5-486f-ba6b-74f43ede99b7', tool_call_id='call_ysagmZPkenN7bxcJaW15Z1Uq'), AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_0097ZtXOYoEQpYab9JfQJc4H', 'function': {'arguments': '{"query":"decision-making framework for choosing what to eat"}', 'name': 'retrieve'}, 'type': 'function'}], 'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 20, 'prompt_tokens': 214, 'total_tokens': 234, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-2024-08-06', 'system_fingerprint': 'fp_d8864f8b6b', 'id': 'chatcmpl-BZNptJb4K3Y5jPYTmESKGjr6iVcM3', 'service_tier': 'default', 'finish_reason': 'tool_calls', 'logprobs': None}, name='decision_maker_agent', id='run--3874288a-4336-4814-b6da-e2e0fb614bbf-0', tool_calls=[{'name': 'retrieve', 'args': {'query': 'decision-making framework for choosing what to eat'}, 'id': 'call_0097ZtXOYoEQpYab9JfQJc4H', 'type': 'tool_call'}], usage_metadata={'input_tokens': 214, 'output_tokens': 20, 'total_tokens': 234, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}), ToolMessage(content='(\'Let go of the idea of the \\\'perfect decision\\\'  Think about the last time you were looking through a giant menu at a restaurant, frozen by the possibility that you might make the "wrong" choice. This happens to me all the time when I\\\'m back home in Jersey and go to one of the many local diners. The descriptions of my options blur together, and I\\\'m hawking the plates at neighboring tables to see what looks good.  Sheena Iyengar, an expert on choice and decision making, says that much of the pressure we feel to make a \\\'perfect\\\' choice stems from how much we associate our choices with our identity.  \\n\\n\\nLife Kit \\nFaced With A Tough Decision? The Key To Choosing May Be Your Mindset\\n\\nLife Kit \\nFaced With A Tough Decision? The Key To Choosing May Be Your Mindset\\n\\n\\n\\n\\n\\n\\n"I\\\'m always asking myself, \\\'Who am I? And given who I am, what do I want? And given what I want, what should I choose? And if I choose X or Y or Z? Am I sending the right message to you about who I am and what I stand for?\\\' That\\\'s a lot of burden to carry," says Iyengar.  Holding on to the idea of a perfect choice can keep us from actually choosing. When in reality, the worst-case scenario for me at the diner would be that I order pancakes and end up wishing I had gotten an omelet instead.  \\nSponsor Message\\n\\n\\n\\n\\n\\nAllow yourself three to five options max \\n\\n  Having too many choices can cause "analysis paralysis." Credit: Becky Harlan/NPR\\n\\nEnlarge this image\\n\\n\\n\\n\\n\\n\\n\\n\\n        \\n        Photo Illustration by Becky Harlan/NPR\\n        \\n    \\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n            \\n            Photo Illustration by Becky Harlan/NPR\\n            \\n        \\n\\n\\n\\nFrom there, consider how much you actually care about the choice you\\\'re trying to make.  If I get hung up on two pretty similar options, like Rice Krispies or Special K, getting out of the gridlock is ultimately more important than whatever cereal I end up choosing. This is known as making a satisficing or a \\\'good enough\\\' decision, where any choice will do just fine.  "Basically flip a coin," says Brooke Struck, who\\\'s the research director of The Decision Lab, a think tank that specializes in behavioral science. He means this literally.  On the other hand, if you care more about the decision you\\\'re making, keep track of your options with a list so that you have a clean, controlled environment to sort through when it comes time to choose.  Practice trusting yourself\\n\\nMaking decisions requires us to choose and commit to a certain life pathway, while at the same time saying no to the alternative. For example, here are some decisions I’ve faced so far this week:\\n\\nShall I have oatmeal or toast for breakfast?\\nShall I go for a run or take a nap on the couch?\\nShall I live in the U.K. or move back to New Zealand?\\nShall we try for a third child or stick with the two we have?\\n\\n\\nIn each of these, you can hear the potential for one door to be opened and another one to be closed. Some of these decisions are, of course, less impactful; while some are deep and wide-reaching.\\nProblematic indecisiveness is a common feature of modern living, in part as a result of the increase in choices that is now available to us. However, some people glide through life, making choices with ease, committing and seemingly able to deal with the consequences. But for others, decisions are incredibly fear-inducing; there are typically 3 reasons for this:\', [Document(metadata={\'description\': \'We make so many basic decisions each day that it\\\'s easy to fall into "analysis paralysis." We explore where indecision comes from, why so many of us are sweating the small stuff and what you can do about it.\', \'language\': \'en\', \'source\': \'https://www.npr.org/2022/03/07/1084907897/any-decision-is-better-than-indecision-try-these-tips-to-actually-choose\', \'title\': \'Sharpen your decision making skills  : Life Kit : NPR\'}, page_content=\'Let go of the idea of the \\\'perfect decision\\\'  Think about the last time you were looking through a giant menu at a restaurant, frozen by the possibility that you might make the "wrong" choice. This happens to me all the time when I\\\'m back home in Jersey and go to one of the many local diners. The descriptions of my options blur together, and I\\\'m hawking the plates at neighboring tables to see what looks good.  Sheena Iyengar, an expert on choice and decision making, says that much of the pressure we feel to make a \\\'perfect\\\' choice stems from how much we associate our choices with our identity.  \\n\\n\\nLife Kit \\nFaced With A Tough Decision? The Key To Choosing May Be Your Mindset\'), Document(metadata={\'title\': \'Sharpen your decision making skills  : Life Kit : NPR\', \'language\': \'en\', \'description\': \'We make so many basic decisions each day that it\\\'s easy to fall into "analysis paralysis." We explore where indecision comes from, why so many of us are sweating the small stuff and what you can do about it.\', \'source\': \'https://www.npr.org/2022/03/07/1084907897/any-decision-is-better-than-indecision-try-these-tips-to-actually-choose\'}, page_content=\'Life Kit \\nFaced With A Tough Decision? The Key To Choosing May Be Your Mindset\\n\\n\\n\\n\\n\\n\\n"I\\\'m always asking myself, \\\'Who am I? And given who I am, what do I want? And given what I want, what should I choose? And if I choose X or Y or Z? Am I sending the right message to you about who I am and what I stand for?\\\' That\\\'s a lot of burden to carry," says Iyengar.  Holding on to the idea of a perfect choice can keep us from actually choosing. When in reality, the worst-case scenario for me at the diner would be that I order pancakes and end up wishing I had gotten an omelet instead.  \\nSponsor Message\\n\\n\\n\\n\\n\\nAllow yourself three to five options max \\n\\n  Having too many choices can cause "analysis paralysis." Credit: Becky Harlan/NPR\'), Document(metadata={\'title\': \'Sharpen your decision making skills  : Life Kit : NPR\', \'source\': \'https://www.npr.org/2022/03/07/1084907897/any-decision-is-better-than-indecision-try-these-tips-to-actually-choose\', \'description\': \'We make so many basic decisions each day that it\\\'s easy to fall into "analysis paralysis." We explore where indecision comes from, why so many of us are sweating the small stuff and what you can do about it.\', \'language\': \'en\'}, page_content=\'Enlarge this image\\n\\n\\n\\n\\n\\n\\n\\n\\n        \\n        Photo Illustration by Becky Harlan/NPR\\n        \\n    \\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n            \\n            Photo Illustration by Becky Harlan/NPR\\n            \\n        \\n\\n\\n\\nFrom there, consider how much you actually care about the choice you\\\'re trying to make.  If I get hung up on two pretty similar options, like Rice Krispies or Special K, getting out of the gridlock is ultimately more important than whatever cereal I end up choosing. This is known as making a satisficing or a \\\'good enough\\\' decision, where any choice will do just fine.  "Basically flip a coin," says Brooke Struck, who\\\'s the research director of The Decision Lab, a think tank that specializes in behavioral science. He means this literally.  On the other hand, if you care more about the decision you\\\'re making, keep track of your options with a list so that you have a clean, controlled environment to sort through when it comes time to choose.  Practice trusting yourself\'), Document(metadata={\'source\': \'https://www.psychologytoday.com/us/blog/the-mindful-path-to-self-acceptance/202103/how-to-break-free-from-the-prison-of-indecisiveness\', \'language\': \'en-US\', \'title\': \'How to Break Free From the Prison of Indecisiveness | Psychology Today\', \'description\': \'Are you caught in the prison of indecision? Here are some ideas to free yourself.\'}, page_content=\'Making decisions requires us to choose and commit to a certain life pathway, while at the same time saying no to the alternative. For example, here are some decisions I’ve faced so far this week:\\n\\nShall I have oatmeal or toast for breakfast?\\nShall I go for a run or take a nap on the couch?\\nShall I live in the U.K. or move back to New Zealand?\\nShall we try for a third child or stick with the two we have?\\n\\n\\nIn each of these, you can hear the potential for one door to be opened and another one to be closed. Some of these decisions are, of course, less impactful; while some are deep and wide-reaching.\\nProblematic indecisiveness is a common feature of modern living, in part as a result of the increase in choices that is now available to us. However, some people glide through life, making choices with ease, committing and seemingly able to deal with the consequences. But for others, decisions are incredibly fear-inducing; there are typically 3 reasons for this:\')])', name='retrieve', id='7c3d73b4-b6d0-4538-87f6-d39a8626c453', tool_call_id='call_0097ZtXOYoEQpYab9JfQJc4H'), AIMessage(content='When deciding what to eat for lunch, it\'s important to let go of the idea of making the "perfect" decision. Here are some tips to help you choose:\n\n1. **Limit Your Options**: Allow yourself three to five options max. Having too many choices can lead to "analysis paralysis."\n\n2. **Consider How Much You Care**: If the decision isn\'t that important, making a "good enough" choice is fine. You can even flip a coin if you\'re stuck between two similar options.\n\n3. **Trust Yourself**: Practice trusting your instincts and make a choice. Remember, the worst-case scenario is often not as bad as it seems.\n\nIf you\'re still unsure, try listing your options and see which one stands out to you. Remember, any decision is better than indecision.', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 161, 'prompt_tokens': 2336, 'total_tokens': 2497, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-2024-08-06', 'system_fingerprint': 'fp_d8864f8b6b', 'id': 'chatcmpl-BZNpvTQTcRvRbfRzXplpq1MMru7ZW', 'service_tier': 'default', 'finish_reason': 'stop', 'logprobs': None}, name='decision_maker_agent', id='run--8f1dcc00-b965-4987-9e54-ec7512b5e63a-0', usage_metadata={'input_tokens': 2336, 'output_tokens': 161, 'total_tokens': 2497, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}), AIMessage(content='Transferring back to supervisor', additional_kwargs={}, response_metadata={'__is_handoff_back': True}, name='decision_maker_agent', id='4c9f77e5-a075-4cff-a29a-6fdf4857fcd9', tool_calls=[{'name': 'transfer_back_to_supervisor', 'args': {}, 'id': '4af96471-4c7c-4b26-a89b-d280462f8a9f', 'type': 'tool_call'}]), ToolMessage(content='Successfully transferred back to supervisor', name='transfer_back_to_supervisor', id='5e25babe-6021-45de-9d87-cdf595c6a2bd', tool_call_id='4af96471-4c7c-4b26-a89b-d280462f8a9f'), AIMessage(content='If you have any more questions or need further assistance, feel free to ask!', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 17, 'prompt_tokens': 2776, 'total_tokens': 2793, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-2024-08-06', 'system_fingerprint': 'fp_d8864f8b6b', 'id': 'chatcmpl-BZNpz0RnJgf8G2T59MMdOmzTa2hzL', 'service_tier': 'default', 'finish_reason': 'stop', 'logprobs': None}, name='supervisor', id='run--184a4fb3-f225-4b14-be49-9d327627763b-0', usage_metadata={'input_tokens': 2776, 'output_tokens': 17, 'total_tokens': 2793, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})]}
                                    '''}, config={"thread_id": 123456})

print(response)


